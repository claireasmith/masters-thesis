---
title: "Testing for intraspecific size number tradeoff"
author: "Claire Smith"
date: "2023-06-28"
output: github_document
editor_options: 
  chunk_output_type: console
always_allow_html: true
---

Investigating the relationship between pollen size and number within wind-pollinated species using linear regression: pollen number ~ pollen volume

```{r initialize, message=F}
library(tidyverse)
library(ggplot2)
library(lme4)
library(lmerTest)
source("theme_cs.R")
```

```{r read in data}
prodfull <- read.csv("processed-data/size-prod-norep.csv", stringsAsFactors = T) # has individual-level pollen size and number data
# head(prodfull)
# str(prodfull)
# summary(prodfull)
```

```{r summary of size number data}
prod_summary <- prodfull  %>% group_by(Species, source, Sex_sys) %>% 
  summarize(mean_diam = mean(Avg_diam, na.rm=T), 
            sd_diam = sd(Avg_diam, na.rm=T),
            cv_diam = sd_diam/mean_diam,
            mean_polanth = mean(Avg_pol_anth, na.rm=T),
            sd_polanth = sd(Avg_pol_anth, na.rm=T),
            cv_polanth = sd_polanth/mean_polanth,
            n=n()) %>%  
  filter(n>=5) %>% 
  droplevels() %>% 
  arrange(Sex_sys, Species) %>% 
  as.data.frame()

prod_summary$anth_msd <- paste0(round(prod_summary$mean_polanth,0)," \U00B1 ",round(prod_summary$sd_polanth,0))
prod_summary$diam_msd <- paste0(round(prod_summary$mean_diam,0)," \U00B1 ",round(prod_summary$sd_diam,0))

prod_summary_filt <- prod_summary 
#write it to a file I will make a table with 
write.csv(prod_summary_filt, "processed-data/sizeprod-summary.csv", row.names = F, fileEncoding = "UTF-8")

# how variable is pollen vol/num across species? 
# Pollen size seems much less variable - I'll run a t test of mean cv for diameter vs mean cv for pollen per anther to determine if pollen size is significantly less variable than pollen production
mean(prod_summary$cv_diam)
sd(prod_summary$cv_diam)
mean(prod_summary$cv_polanth)
sd(prod_summary$cv_polanth)
cvtest <- prod_summary %>% select(cv_diam, cv_polanth)
t.test(x=cvtest$cv_polanth, y=cvtest$cv_diam, paired=T) # t test across all species
```

Pollen diameter is less variable than pollen size. The CV for pollen diameter is significantly less than the CV for pollen production per anther. 

```{r}
head(prodfull)
summary(prodfull)
prod <- prodfull %>% 
  filter(!is.na(Avg_diam) & !is.na(Avg_pol_anth)) %>% # want only entries with both size and prod values
  # remove outliers
  filter(!(Species=="Phleum pratense"&Ind=="C11")) %>% 
  filter(!(Species=="Elymus innovatus"&Ind=="EI01"))
# summary(prod)
```

Now I want to build a model for each species. First I'll go through each species and look at the distributions of pollen size and number, as well as if they have any other explanatory variables (like site) that might be useful

```{r prepare data for models}
#nest data by species to make it easier to handle
by_spp <- prod %>% group_by(Species, Sex_sys) %>% 
  nest() %>% 
  arrange(Sex_sys, Species) %>% 
  # Keep only species with at least 10 entries %>% 
  mutate(nind = purrr::map(data, nrow)) %>% 
  filter(nind>=10)
# by_spp # 23 species remaining

#inspect distributions of mean pollen diam and pollen production for each species - are they symmetric? any obvious outliers? 
#define function for this
checkfun <- function(df,i){
  spec = as.character(df[i,]$Species)
  n=length(df[i,]$data[[1]]$Avg_diam)
  hist(df[i,]$data[[1]]$Avg_diam, main=paste(spec, "n=",n), xlab="Mean pollen diameter")
  hist(log(df[i,]$data[[1]]$Avg_diam), main=paste(spec, "n=",n), xlab="Log mean pollen diameter")
  hist(df[i,]$data[[1]]$Avg_pol_anth, main=paste(spec, "n=",n), xlab="Mean pollen per anther")
  hist(log(df[i,]$data[[1]]$Avg_pol_anth), main=paste(spec, "n=",n), xlab="Log mean pollen per anther")
}

checkfun(by_spp,2)
```

```{r}
#run through species and record in an excel file "within species size number tradeoff pre model fit sum.xlsx"
```

### LINEAR REGRESSION MODELS AND FIGURES

Run linear models and plot them 

```{r, linear regression models, cols.print=14}
#define function to run model 
spp_model <- function(df) {
  lm(Avg_pol_anth ~ Avg_diam, data = df)
}
#run models and add model to by_spp dataframe
by_spp <- by_spp %>% 
  mutate(model = purrr::map(data, spp_model)) %>% 
  arrange(Sex_sys, Species) # arrange in order of sex sys, then alphabetical
#get model summary using glance() from "broom"
glance <- by_spp %>% 
  mutate(glance = purrr::map(model, broom::glance)) %>% 
  unnest(glance, .drop=T)
# put this in a viewable format (remove nested data and model info)
glancetab <- glance %>% select(-c(data, model)) %>% 
  arrange(Sex_sys, Species)
#save this in a new table without the ugly list elements, which I can print to a file
glancetab_write <- glance %>% select(-c(data, model)) %>% 
  arrange(Sex_sys, Species) %>% apply(2, as.character) # coercing all columns to characters so that I can write this to a file
write.csv(glancetab_write, "processed-data/tradeoff-reg-model-sum.csv", row.names = F)
#take a look
print(glancetab, n=Inf)

#similar - but using broom::tidy(), gives me model coefficients
tidy <- by_spp %>% 
  mutate(tidy = purrr::map(model, broom::tidy)) %>% 
  unnest(tidy, .drop=T)
tidytab <- tidy %>% select(-c(data, model)) %>% 
  arrange(Sex_sys, Species)
print(tidytab, n=46)
tidytab_write <- tidy %>% select(-c(data, model)) %>% 
  arrange(Sex_sys, Species) %>% apply(2, as.character)
write.csv(tidytab_write, "processed-data/tradeoff-reg-model-coefs.csv", row.names = F)
#take a look
# print(tidytab, n=Inf)

#take a look at r.squared values
# glance %>% 
#   ggplot(aes(spp, r.squared)) + 
#   geom_point() + 
#   theme(axis.text = element_text(angle=90))
# take a look at all data
# prod %>% filter(spp %in% keepspp) %>% 
#   ggplot(aes(x=polvol, y=polanth)) +
#   geom_point() +
#   facet_wrap(.~spp, scales="free")

```

```{r}
#take only species with significant relationships to plot with linear model overtop
sigsub <- glance %>% filter(p.value<0.05) #7 species
#Plot relationship between size and number for the 7 species with a significant relationship
# sigsub$Species
```

```{r Bromus inermis tradeoff}
# Bromus inermis
sigsub[which(sigsub$Species=="Bromus inermis"),]$data %>% 
  as.data.frame() %>% 
  ggplot(aes(x=Avg_diam, y=Avg_pol_anth)) + 
  geom_point() + 
  geom_smooth(method="lm", se=F) + 
  scale_y_continuous(name="Pollen production per anther") + 
  scale_x_continuous(name=expression(paste("Pollen diameter (", mu, "m",")"))) + 
  theme_cs(font = "sans")
```

```{r Elymus innovatus tradeoff}
# Elymus innovatus
sigsub[which(sigsub$Species=="Elymus innovatus"),]$data %>% 
  as.data.frame() %>% 
  ggplot(aes(x=Avg_diam, y=Avg_pol_anth)) + 
  geom_point() + 
  geom_smooth(method="lm", se=F) + 
  scale_y_continuous(name="Pollen production per anther") + 
  scale_x_continuous(name=expression(paste("Pollen diameter (", mu, "m",")"))) + 
  theme_cs(font = "sans")
```

```{r Festuca campestris tradeoff}
#Festuca campestris
sigsub[which(sigsub$Species=="Festuca campestris"),]$data %>% 
  as.data.frame() %>% 
  ggplot(aes(x=Avg_diam, y=Avg_pol_anth)) + 
  geom_point() + 
  geom_smooth(method="lm", se=F) + 
  scale_y_continuous(name="Pollen production per anther") + 
  scale_x_continuous(name=expression(paste("Pollen diameter (", mu, "m",")"))) + 
  theme_cs(font = "sans")
```

```{r Festuca pratensis tradeoff}
# Festuca pratensis
sigsub[which(sigsub$Species=="Festuca pratensis"),]$data %>% 
  as.data.frame() %>% 
  ggplot(aes(x=Avg_diam, y=Avg_pol_anth)) + 
  geom_point() + 
  geom_smooth(method="lm", se=F) + 
  scale_y_continuous(name="Pollen production per anther") + 
  scale_x_continuous(name=expression(paste("Pollen diameter (", mu, "m",")"))) + 
  theme_cs(font = "sans")
```

```{r Koeleria cristata tradeoff}
# Koeleria cristata
sigsub[which(sigsub$Species=="Koeleria cristata"),]$data %>% 
  as.data.frame() %>% 
  ggplot(aes(x=Avg_diam, y=Avg_pol_anth)) + 
  geom_point() + 
  geom_smooth(method="lm", se=F) + 
  scale_y_continuous(name="Pollen production per anther") + 
  scale_x_continuous(name=expression(paste("Pollen diameter (", mu, "m",")"))) + 
  theme_cs(font = "sans")
```

```{r Plantago lanceolata tradeoff}
# Plantago lanceolata
sigsub[which(sigsub$Species=="Plantago lanceolata"),]$data %>% 
  as.data.frame() %>% 
  ggplot(aes(x=Avg_diam, y=Avg_pol_anth)) + 
  geom_point() + 
  geom_smooth(method="lm", se=F) + 
  scale_y_continuous(name="Pollen production per anther") + 
  scale_x_continuous(name=expression(paste("Pollen diameter (", mu, "m",")"))) + 
  theme_cs(font = "sans")
```

```{r Amaranthus retroflexus tradeoff}
#Amaranthus retroflexus
sigsub[which(sigsub$Species=="Amaranthus retroflexus"),]$data %>% 
  as.data.frame() %>% 
  ggplot(aes(x=Avg_diam, y=Avg_pol_anth)) + 
  geom_point() + 
  geom_smooth(method="lm", se=F) + 
  scale_y_continuous(name="Pollen production per anther") + 
  scale_x_continuous(name=expression(paste("Pollen diameter (", mu, "m",")"))) + 
  theme_cs(font = "sans")
```


Found a significantly negative relationship between pollen volume and number (i.e. size-number trade-off) in 4/15 species (only taking species with at least 15 entries for pollen size/number). Found a significantly positive relationship between size and number in 1 species (Leymus innovatus). 

