---
title: "Full pollen load model, including stig length"
author: "Claire Smith"
date: "2023-06-19"
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r initialize, message=F}
# Load packages
library(tidyverse)
library(lme4) # for linear mixed effects models
library(lmerTest)
library(emmeans)
library(car)
library(knitr)
# Source files
source("clean-stig-01.R")
source("clean-stig-02.R")
source("theme_cs.R")
# Load data
stig <- read.csv("processed-data/stig-all.csv", stringsAsFactors = T)
stig$Date <- as.Date(stig$Date)
stig$Sex_sys <- as.factor(stig$Sex_sys)
stig$source <- as.factor(stig$source)
summary(stig)
```

I think stigma length is probably an important covariate for determining pollen load. I'll pull out only the species that have stigma length measurements. I'll run a full model to predict pollen load: pollen load ~ stigma length + density + height. These will all be JF species so the measure for height will be inflorescence max height. 

### Prepare data

```{r pre-processing data}

# I'll go through each species and run a model predicting pollen capture by flower height

# Since many likely have log-normal distributions of pollen capture, I'll create a log flw pollen variable now to # save time -- but will still check each species individually 
stigl <- stig %>% 
  mutate(Log_flw_pollen=log(Flw_pollen + 1)) %>% 
  rowwise %>% 
  mutate(Avg_dist = mean(c_across(c('D1', 'D2', 'D3', 'D4', 'D5')), na.rm=TRUE)) %>% 
  # Take only entries stigma length data
  filter(!is.na(Flw_pollen) & !is.na(Infl_max) & !is.na(Avg_dist) &!is.na(Stigma_length) & !is.na(Date))
```

```{r take a look at data, include=F}
# How many species have max infl height and stigma length? 
unique(stigl$Species) #  13 species 
# [1] Ambrosia artemisiifolia Chenopodium album       Carex communis          Carex hirtifolia       
#  [5] Carex pedunculata       Carex plantaginea       Carex stipata           Plantago lanceolata    
#  [9] Rumex acetosella        Rumex crispus           Scirpus microcarpus     Schizacne purpurascens 
# [13] Thalictrum dioicum
# View(stigl)

# Flower is nested within plant - each plant has (potentially) multiple flowers measured within it -- need to 
# create a unique plant ID for each plant within a species
stigl$Ind_ID=paste(stigl$Date, stigl$Site, stigl$Plant, sep = "-")
#How many unique individuals per species? 
stigl %>% group_by(Species) %>%
  distinct(Plant) %>% 
  summarize(n=n())
#   Species                     n
#    <fct>                   <int>
#  1 Ambrosia artemisiifolia    30
#  2 Carex communis             22
#  3 Carex hirtifolia           25
#  4 Carex pedunculata          15
#  5 Carex plantaginea          19
#  6 Carex stipata              30
#  7 Chenopodium album          29
#  8 Plantago lanceolata        30
#  9 Rumex acetosella           30
# 10 Rumex crispus              25
# 11 Schizacne purpurascens     30
# 12 Scirpus microcarpus        30
# 13 Thalictrum dioicum         20

#How many total flowers? There are multiple flowers measured per plant
stigl %>% group_by(Species) %>%
  summarize(n=n())

stigl %>% group_by(Species, Plant) %>%
  summarize(n=n())
# View(stigl)
```

### Ambrosia artemisiifolia (n=30)

```{r AMAR pre-fit, include=F}
AMAR <- stigl %>% 
  filter(Species=="Ambrosia artemisiifolia") %>% 
  as.data.frame()
# summary(AMAR) 
AMAR$Inv_avg_dist <- 1/(AMAR$Avg_dist)
```

```{r AMAR take a look, include=F}
#Taking a look at the data
hist(AMAR$Flw_pollen) # response variable. looks very right skewed!
hist(AMAR$Log_flw_pollen) # much more symmetric
hist(AMAR$Infl_max) # looks ok
hist(AMAR$Stigma_length)
hist(AMAR$Avg_dist)
hist(AMAR$Inv_avg_dist)
table(AMAR$Date)
```

```{r AMAR covariates and pollen load, include=F}
# Look at plot of Log_flw_pollen and Flw_height 
# Looks like no big differences between sites in flower height or pollen load
ggplot(data=AMAR, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=AMAR, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=AMAR, aes(x=Avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=AMAR, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs() # dates are in number format

# summary(AMAR)
```

```{r AMAR model fit }
#model for height
AMARmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=AMAR)
summary(AMARmod)
kable(anova(AMARmod))
# No significant effect of density or max inflorescence height - significant effect of stigma length. Longer stigmas capture more pollen. 
# plot(AMARmod)
```

No significant effect of anything on pollen capture

```{r test AMAR model assumptions, include=F}
#normality of residuals
hist(residuals(AMARmod)) 
qqnorm(residuals(AMARmod))
qqline(residuals(AMARmod))
# homogeneity
plot(AMARmod)
# No obvious deviations from normality - variance in residuals does seem to decrease with increased fitted values. 
```

```{r AMAR calculate marginal means}
AMARmod.fit <- AMAR
fit.AMARmod <- fitted(AMARmod)
AMARmod.fit <- mutate(AMARmod.fit, fit.AMARmod)
emmsAMAR <- emmip(AMARmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

Fitted values with line of best fit: 

```{r AMAR fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
# ggplot() + 
#   geom_point(data = AMARmod.fit, aes(x=Stigma_length, y=fit.AMARmod)) + 
#   geom_smooth(data=AMARmod.fit, aes(x=Stigma_length, y=fit.AMARmod),
#               method="lm",
#               formula = y ~ x, linetype=1, colour="blue", se=F, linewidth=0.7) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(log(10)+1,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)",
#                      breaks = log(c(0.5, 1, 2, 5)),
#                      labels = c(0.5, 1, 2, 5),
#                      limits=c(0.5,5)) +
#   theme_cs()
```

Raw data with emmip slope: 

```{r AMAR fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = AMAR, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsAMAR, aes(xvar, yvar), linewidth=0.7) + # emmip slope
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   # scale_x_continuous(name = "Stigma length (cm)",
#   #                    breaks = log(c(0, 0.1, 0.2, 0.5 , 1, 2, 5)),
#   #                    labels = c(0, 0.1, 0.2, 0.5, 1, 2, 5)) + 
#     scale_x_continuous(name = "Stigma length (cm)") + 
# 
#                      # breaks = log(c(0.5, 1, 2, 5)),
#                      # labels = c(0.5, 1, 2, 5),
#                      # limits=c(0.5,5)) +
#   theme_cs()
# 
# # max(AMAR$Stigma_length)
```

### Carex communis (n=22)

```{r CACO pre-fit}
CACO <- stigl %>% 
  filter(Species=="Carex communis") %>% 
  as.data.frame()
# summary(CACO) 
CACO$Inv_avg_dist <- 1/(CACO$Avg_dist)
```

```{r look at data, include=F}
#Taking a look at the data
hist(CACO$Flw_pollen) # response variable. looks very right skewed!
hist(CACO$Log_flw_pollen) # much more symmetric
hist(CACO$Infl_max) # looks ok
hist(CACO$Stigma_length) # looks ok
# hist(log(CACO$Stigma_length))
# min(CACO$Stigma_length) #1.7
# CACO$Log_stigma_length <- log(AMAR$Stigma_length)
hist(CACO$Avg_dist)
hist(CACO$Inv_avg_dist)
table(CACO$Date)
```

```{r CACO covariates and pollen load, include=F}
# Look at plot of Log_flw_pollen and Flw_height 
# Looks like no big differences between sites in flower height or pollen load
ggplot(data=CACO, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CACO, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CACO, aes(x=Inv_avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CACO, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r CACO model fit}
# fit full model with all terms
CACOmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=CACO)
summary(CACOmod)
kable(anova(CACOmod))
```

Significant effect of stigma length on pollen capture. 

```{r test CACO model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=CACOmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(CACOmod)) 
qqnorm(residuals(CACOmod))
qqline(residuals(CACOmod))
# homogeneity
plot(CACOmod)
# No obvious deviations from normality or homogeneity of residuals. 
```

```{r CACO estimate marginal means}
CACOmod.fit <- CACO
fit.CACOmod <- fitted(CACOmod)
CACOmod.fit <- mutate(CACOmod.fit, fit.CACOmod)
emmsCACO <- emmip(CACOmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

```{r CACO stig length fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CACOmod.fit, aes(x=Stigma_length, y=fit.CACOmod)) + 
  geom_smooth(data=CACOmod.fit, aes(x=Stigma_length, y=fit.CACOmod),
              method="lm",
              formula = y ~ x, linetype=1, colour="blue", se=F, linewidth=0.7) + 
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r CACO fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = CACO, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsCACO, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = CACO, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```

### Carex hirtifolia (n=25)

```{r CAHI pre-fit}
CAHI <- stigl %>% 
  filter(Species=="Carex hirtifolia") %>% 
  as.data.frame()
# summary(CAHI) 
CAHI$Inv_avg_dist <- 1/(CAHI$Avg_dist)
```

```{r CAHI take a look, include=F}
#Taking a look at the data
hist(CAHI$Flw_pollen) # response variable. looks very right skewed!
hist(CAHI$Log_flw_pollen) # much more symmetric
hist(CAHI$Infl_max) # looks ok
hist(CAHI$Stigma_length) # looks ok - looks like one very small? 
hist(CAHI$Avg_dist)
hist(CAHI$Inv_avg_dist)
table(CAHI$Date)

# remove outlier identified below...
# CAHI[which(CAHI$Stigma_length<1),] # small stigma has length 0.2 (most are between 2-3)
CAHI <- CAHI %>% filter(Stigma_length>0.5)
```

```{r CAHI covariates and pollen load, include=F}
ggplot(data=CAHI, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAHI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
# okay that one weird small stigma needs to go - probably was cut off short by something? 
ggplot(data=CAHI, aes(x=Avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAHI, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r CAHI model fit}
# fit full model with all terms
CAHImod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=CAHI)
summary(CAHImod)
# anova(CAHImod)
kable(anova(CAHImod))
```

Significant effect of stigma length on pollen capture. 

```{r test CAHI model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=CAHImod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(CAHImod)) 
qqnorm(residuals(CAHImod))
qqline(residuals(CAHImod))
# homogeneity
plot(CAHImod)
# No obvious deviations from normality or homogeneity of residuals. 
```

```{r CAHI estimate marginal means}
CAHImod.fit <- CAHI
fit.CAHImod <- fitted(CAHImod)
CAHImod.fit <- mutate(CAHImod.fit, fit.CAHImod)
emmsCAHI <- emmip(CAHImod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

```{r CAHI stig length fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CAHImod.fit, aes(x=Stigma_length, y=fit.CAHImod)) + 
  geom_smooth(data=CAHImod.fit, aes(x=Stigma_length, y=fit.CAHImod),
              method="lm",
              formula = y ~ x, linetype=1, colour="blue", se=F, linewidth=0.7) + 
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r CAHI fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = CAHI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsCAHI, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = CAHI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```

### Carex pedunculata (n=15)

```{r CAPE pre-fit}
CAPE <- stigl %>% 
  filter(Species=="Carex pedunculata") %>% 
  as.data.frame()
# summary(CAPE) 
CAPE$Inv_avg_dist <- 1/(CAPE$Avg_dist)
```

```{r CAPE take a look, include=F}
#Taking a look at the data
hist(CAPE$Flw_pollen) # response variable. looks very right skewed!
hist(CAPE$Log_flw_pollen) # much more symmetric
hist(CAPE$Infl_max) # looks ok
hist(CAPE$Stigma_length) # looks ok 
hist(CAPE$Avg_dist)
hist(CAPE$Inv_avg_dist)
table(CAPE$Date)
```

```{r CAPE covariates and pollen load, include=F}
ggplot(data=CAPE, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAPE, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAPE, aes(x=Inv_avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAPE, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r CAPE model fit}
# fit full model with all terms
CAPEmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=CAPE)
summary(CAPEmod)
# anova(CAPEmod)
kable(anova(CAPEmod))
```

Significant effect of stigma length on pollen capture. 

```{r test CAPE model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=CAPEmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(CAPEmod))
qqnorm(residuals(CAPEmod))
qqline(residuals(CAPEmod))
# homogeneity
plot(CAPEmod)
# No obvious deviations from normality or homogeneity of residuals. 
```

```{r CAPE estimate marginal means}
CAPEmod.fit <- CAPE
fit.CAPEmod <- fitted(CAPEmod)
CAPEmod.fit <- mutate(CAPEmod.fit, fit.CAPEmod)
emmsCAPE <- emmip(CAPEmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

```{r CAPE stig length fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CAPEmod.fit, aes(x=Stigma_length, y=fit.CAPEmod)) + 
  # geom_smooth(data=CAPEmod.fit, aes(x=Stigma_length, y=fit.CAPEmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="blue", se=F, linewidth=0.7) + 
  geom_line(data= emmsCAPE, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r CAPE fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = CAPE, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsCAPE, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = CAPE, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```

### Carex plantaginea (n=19)

```{r CAPL pre-fit}
CAPL <- stigl %>% 
  filter(Species=="Carex plantaginea") %>% 
  as.data.frame()
# summary(CAPL) 
CAPL$Inv_avg_dist <- 1/(CAPL$Avg_dist)
```

```{r CAPL take a look, include=F}
#Taking a look at the data
hist(CAPL$Flw_pollen) # response variable. looks very right skewed!
hist(CAPL$Log_flw_pollen) # much more symmetric
hist(CAPL$Infl_max) # looks ok
hist(CAPL$Stigma_length) # looks ok
hist(CAPL$Avg_dist)
hist(CAPL$Inv_avg_dist)
table(CAPL$Date)
```

```{r CAPL covariates and pollen load, include=F}
ggplot(data=CAPL, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAPL, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAPL, aes(x=Inv_avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAPL, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r CAPL model fit}
# fit full model with all terms
CAPLmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=CAPL)
summary(CAPLmod)
# anova(CAPLmod)
kable(anova(CAPLmod))
```

Significant effect of date on pollen capture. 

```{r test CAPL model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=CAPLmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(CAPLmod))
qqnorm(residuals(CAPLmod))
qqline(residuals(CAPLmod))
# homogeneity
plot(CAPLmod)
# Values seem to diverge from qqline near positive extreme. No clear violation of homoskedasticity. 
```

```{r CAPL estimate marginal means}
CAPLmod.fit <- CAPL
fit.CAPLmod <- fitted(CAPLmod)
CAPLmod.fit <- mutate(CAPLmod.fit, fit.CAPLmod)
emmsCAPL <- emmip(CAPLmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)

CAPLmod.fit2 <- CAPL
fit.CAPLmod2 <- fitted(CAPLmod)
CAPLmod.fit2 <- mutate(CAPLmod.fit2, fit.CAPLmod2)
emmsCAPL2 <- emmip(CAPLmod, ~ Date, cov.reduce=range,
              type="response", plotit=F)
```

```{r CAPL date fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CAPLmod.fit2, aes(x=Date, y=fit.CAPLmod2)) + 
  # geom_smooth(data=CAPLmod.fit2, aes(x=Date, y=fit.CAPLmod2),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsCAPL2, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Date", labels=as.character(unique(CAPLmod.fit2$Date)),
                     breaks=unique(CAPLmod.fit2$Date)) +
  theme_cs() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

```

```{r CAPL stig length fitted values plot, dpi=200}
# # emmip_ggplot(emms) #plots predicted slope
# ggplot() + 
#   geom_point(data = CAPLmod.fit, aes(x=Stigma_length, y=fit.CAPLmod)) + 
#   # geom_smooth(data=CAPLmod.fit, aes(x=Stigma_length, y=fit.CAPLmod),
#   #             method="lm",
#   #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
#   geom_line(data= emmsCAPL, aes(xvar, yvar), linewidth=0.7, colour="blue") +
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
#   scale_x_continuous(name = "Stigma length (cm)") +
#   theme_cs()
```

```{r CAPL stig length fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = CAPL, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsCAPL, aes(xvar, yvar), linewidth=0.7, colour="blue") +
#   # geom_smooth(method="lm", data = CAPL, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```

### Carex stipata (n=30)

```{r CAST pre-fit}
CAST <- stigl %>% 
  filter(Species=="Carex stipata") %>% 
  as.data.frame()
# summary(CAST) 
```

```{r CAST take a look, include=F}
#Taking a look at the data
hist(CAST$Flw_pollen) # response variable. probably a lot of 0s here!
hist(CAST$Log_flw_pollen) # still very right skewed...
hist(CAST$Infl_max) # looks ok
hist(CAST$Stigma_length) # looks ok
hist(CAST$Avg_dist)
table(CAST$Date)
```

```{r CAST covariates and pollen load, include=F}
ggplot(data=CAST, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAST, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAST, aes(x=Avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CAST, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r CAST model fit}
# fit full model with all terms
CASTmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Avg_dist + (1|Plant), data=CAST)
summary(CASTmod)
# anova(CASTmod)
kable(anova(CASTmod))
```

boundary (singular) fit: see help('isSingular')...
Significant effect of height, date, stigma length, and avg distance - but is it valid? 

```{r test CAST model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=CASTmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(CASTmod))
qqnorm(residuals(CASTmod))
qqline(residuals(CASTmod))
# homogeneity
plot(CASTmod)
#Values don't fit qqline very well, seems like there's some clear structure in the residuals vs fitted values plot...
```

```{r CAST estimate marginal means}
CASTmod.fit <- CAST
fit.CASTmod <- fitted(CASTmod)
CASTmod.fit <- mutate(CASTmod.fit, fit.CASTmod)
emmsCAST_stiglength <- emmip(CASTmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
emmsCAST_date <- emmip(CASTmod, ~ Date, cov.reduce=range,
              type="response", plotit=F)
emmsCAST_avgdist <- emmip(CASTmod, ~ Avg_dist, cov.reduce=range,
              type="response", plotit=F)
emmsCAST_inflmax <- emmip(CASTmod, ~ Infl_max, cov.reduce=range,
              type="response", plotit=F)
```

```{r CAST stig length fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CASTmod.fit, aes(x=Stigma_length, y=fit.CASTmod)) + 
  # geom_smooth(data=CASTmod.fit, aes(x=Stigma_length, y=fit.CASTmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsCAST_stiglength, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r CAST date fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CASTmod.fit, aes(x=Date, y=fit.CASTmod)) + 
  # geom_smooth(data=CASTmod.fit, aes(x=Stigma_length, y=fit.CASTmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsCAST_date, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Date", labels=as.character(unique(CASTmod.fit$Date)),
                     breaks=unique(CASTmod.fit$Date)) +
  theme_cs()
```

```{r CAST infl max fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CASTmod.fit, aes(x=Infl_max, y=fit.CASTmod)) + 
  # geom_smooth(data=CASTmod.fit, aes(x=Stigma_length, y=fit.CASTmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsCAST_inflmax, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Plant height") +
  theme_cs()
```

```{r CAST avg dist fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CASTmod.fit, aes(x=Avg_dist, y=fit.CASTmod)) + 
  # geom_smooth(data=CASTmod.fit, aes(x=Stigma_length, y=fit.CASTmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsCAST_avgdist, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Average distance to 5 nearest pollen-producing neighbours") +
  theme_cs()
```

```{r CAST stig length fitted slope raw values plot, dpi=200}
ggplot() + 
  geom_point(data = CAST, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_line(data= emmsCAST_stiglength, aes(xvar, yvar), linewidth=0.7) +
  # geom_smooth(method="lm", colour="blue", data = CAST, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
                     limits=c(0,NA)) +
  scale_x_continuous(name = "Stigma length (cm)") + 

    # scale_x_continuous(name = "Stigma length (cm)",
    #                  breaks = log(c(0.5, 1, 2, 5)),
    #                  labels = c(0.5, 1, 2, 5),
    #                  limits=c(log(0.5),log(5))) +
  theme_cs()
```

### Chenopodium album (n=29)

```{r CHAL pre-fit}
CHAL <- stigl %>% 
  filter(Species=="Chenopodium album") %>% 
  as.data.frame()
# summary(CHAL) 
```

```{r CHAL take a look, include=F}
#Taking a look at the data
hist(CHAL$Flw_pollen) # response variable. lots of 0s!
hist(CHAL$Log_flw_pollen) # more symmetric but still very right-skewed
hist(CHAL$Infl_max) # looks ok
hist(CHAL$Stigma_length) # looks ok  
hist(CHAL$Avg_dist)
table(CHAL$Date)
```

```{r CHAL covariates and pollen load, include=F}
ggplot(data=CHAL, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CHAL, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CHAL, aes(x=Avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=CHAL, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r CHAL model fit}
# fit full model with all terms
CHALmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Avg_dist + (1|Plant), data=CHAL)
summary(CHALmod)
# anova(CHALmod)
kable(anova(CHALmod))
```

boundary (singular) fit: see help('isSingular')...

Significant effect of stigma length - but not sure it's valid 

```{r test CHAL model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=CHALmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(CHALmod))
qqnorm(residuals(CHALmod))
qqline(residuals(CHALmod))
# homogeneity
plot(CHALmod)
#Values don't fit qqline well near extremes, seems like there's some clear structure in the residuals vs fitted values plot...
```

```{r CHAL estimate marginal means}
CHALmod.fit <- CHAL
fit.CHALmod <- fitted(CHALmod)
CHALmod.fit <- mutate(CHALmod.fit, fit.CHALmod)
emmsCHAL <- emmip(CHALmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

```{r CHAL fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = CHALmod.fit, aes(x=Stigma_length, y=fit.CHALmod)) + 
  # geom_smooth(data=CHALmod.fit, aes(x=Stigma_length, y=fit.CHALmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsCHAL, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r CHAL fitted slope raw values plot, dpi=200}
ggplot() + 
  geom_point(data = CHAL, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_line(data= emmsCHAL, aes(xvar, yvar), linewidth=0.7) +
  # geom_smooth(method="lm", colour="blue", data = CHAL, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
                     limits=c(0,NA)) +
  scale_x_continuous(name = "Stigma length (cm)") + 

    # scale_x_continuous(name = "Stigma length (cm)",
    #                  breaks = log(c(0.5, 1, 2, 5)),
    #                  labels = c(0.5, 1, 2, 5),
    #                  limits=c(log(0.5),log(5))) +
  theme_cs()
```

### Plantago lanceolata (n=30)

```{r PLLA pre-fit}
PLLA <- stigl %>% 
  filter(Species=="Plantago lanceolata") %>% 
  as.data.frame()
# summary(PLLA) 
```

```{r PLLA take a look, include=F}
#Taking a look at the data
hist(PLLA$Flw_pollen) # response variable. right-skewed
hist(PLLA$Log_flw_pollen) # more symmetric 
hist(PLLA$Infl_max) # looks ok
hist(PLLA$Stigma_length) # looks ok  
hist(PLLA$Avg_dist)
table(PLLA$Date) # lots of dates
```

```{r PLLA covariates and pollen load, include=F}
ggplot(data=PLLA, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=PLLA, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=PLLA, aes(x=Avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=PLLA, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r PLLA model fit}
# fit full model with all terms
PLLAmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Avg_dist + (1|Plant), data=PLLA)
summary(PLLAmod)
# anova(PLLAmod)
kable(anova(PLLAmod))
```

Significant effect of date and stigma length

```{r test PLLA model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=PLLAmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(PLLAmod))
qqnorm(residuals(PLLAmod))
qqline(residuals(PLLAmod))
# homogeneity
plot(PLLAmod)
# Values don't fit qqline very well near extremes
```

```{r PLLA estimate marginal means}
PLLAmod.fit <- PLLA
fit.PLLAmod <- fitted(PLLAmod) 
PLLAmod.fit <- mutate(PLLAmod.fit, fit.PLLAmod)
emmsPLLA_stiglength <- emmip(PLLAmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
emmsPLLA_date <- emmip(PLLAmod, ~ Date, cov.reduce=range,
              type="response", plotit=F)
```

```{r PLLA stig length fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = PLLAmod.fit, aes(x=Stigma_length, y=fit.PLLAmod)) + 
  # geom_smooth(data=PLLAmod.fit, aes(x=Stigma_length, y=fit.PLLAmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsPLLA_stiglength, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r PLLA date fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = PLLAmod.fit, aes(x=Date, y=fit.PLLAmod)) + 
  # geom_smooth(data=PLLAmod.fit, aes(x=Stigma_length, y=fit.PLLAmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsPLLA_date, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Date", labels=as.character(unique(PLLAmod.fit$Date)), 
                     breaks=unique(PLLAmod.fit$Date)) +
  theme_cs() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

```{r PLLA fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = PLLA, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsPLLA, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = PLLA, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```

### Rumex acetosella (n=30)

```{r RUAC pre-fit}
RUAC <- stigl %>% 
  filter(Species=="Rumex acetosella") %>% 
  as.data.frame()
# summary(RUAC)
RUAC$Inv_avg_dist <-1/RUAC$Avg_dist
```

```{r RUAC take a look, include=F}
#Taking a look at the data
hist(RUAC$Flw_pollen) # response variable. right-skewed
hist(RUAC$Log_flw_pollen) # more symmetric 
hist(RUAC$Infl_max) # looks ok, kind of right skewed
hist(RUAC$Stigma_length) # looks ok  
hist(RUAC$Avg_dist)
hist(RUAC$Inv_avg_dist)
table(RUAC$Date) # lots of dates
```

```{r RUAC covariates and pollen load, include=F}
ggplot(data=RUAC, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=RUAC, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=RUAC, aes(x=Inv_avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=RUAC, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r RUAC model fit}
# fit full model with all terms
RUACmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=RUAC)
summary(RUACmod)
anova(RUACmod)
kable(anova(RUACmod))
```

Significant effect of date, stigma length, and avg dist. 

```{r test RUAC model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=RUACmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(RUACmod))
qqnorm(residuals(RUACmod))
qqline(residuals(RUACmod))
# homogeneity
plot(RUACmod)
# No obvious deviations from normality, looks like some structure in the residuals vs fitted values

```

```{r RUAC estimate marginal means}
RUACmod.fit <- RUAC
fit.RUACmod <- fitted(RUACmod) 
RUACmod.fit <- mutate(RUACmod.fit, fit.RUACmod)
emmsRUAC_stiglength <- emmip(RUACmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
emmsRUAC_date <- emmip(RUACmod, ~ Date, cov.reduce=range,
              type="response", plotit=F)
# emmsRUAC_avgdist <- emmip(RUACmod, ~ Avg_dist, cov.reduce=range,
#               type="response", plotit=F)
```

```{r RUAC stig length fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = RUACmod.fit, aes(x=Stigma_length, y=fit.RUACmod)) + 
  # geom_smooth(data=RUACmod.fit, aes(x=Stigma_length, y=fit.RUACmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsRUAC_stiglength, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r RUAC date fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = RUACmod.fit, aes(x=Date, y=fit.RUACmod)) + 
  # geom_smooth(data=RUACmod.fit, aes(x=Stigma_length, y=fit.RUACmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsRUAC_date, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Date", labels=as.character(unique(RUACmod.fit$Date)), 
                     breaks=unique(RUACmod.fit$Date)) +
  theme_cs() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

```{r RUAC avg dist fitted values plot, dpi=200}
# converted avg_dist to inv_avg_dist -- not significant now
# # emmip_ggplot(emms) #plots predicted slope
# ggplot() + 
#   geom_point(data = RUACmod.fit, aes(x=Avg_dist, y=fit.RUACmod)) + 
#   # geom_smooth(data=RUACmod.fit, aes(x=Stigma_length, y=fit.RUACmod),
#   #             method="lm",
#   #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
#   geom_line(data= emmsRUAC_avgdist, aes(xvar, yvar), linewidth=0.7, colour="blue") +
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
#   scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
#   theme_cs()
```

```{r RUAC fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = RUAC, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsRUAC, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = RUAC, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```


### Rumex crispus (n=25)

```{r RUCR pre-fit}
RUCR <- stigl %>% 
  filter(Species=="Rumex crispus") %>% 
  as.data.frame()
# summary(RUCR) 
RUCR$Inv_avg_dist <- 1/(RUCR$Avg_dist)
```

```{r RUCR take a look, include=F}
#Taking a look at the data
hist(RUCR$Flw_pollen) # response variable. right-skewed
hist(RUCR$Log_flw_pollen) # more symmetric 
hist(RUCR$Infl_max) # looks ok, kind of right skewed
hist(RUCR$Stigma_length) # looks ok  
hist(RUCR$Avg_dist) # not very symmetric at all!
hist(RUCR$Inv_avg_dist) # more symmetric 
table(RUCR$Date) # lots of dates
```

```{r RUCR covariates and pollen load, include=F}
ggplot(data=RUCR, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=RUCR, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=RUCR, aes(x=Inv_avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=RUCR, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r RUCR model fit}
# fit full model with all terms
RUCRmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=RUCR)
summary(RUCRmod)
# anova(RUCRmod)
kable(anova(RUCRmod))
```

Significant effect of stigma length

```{r test RUCR model assumptions, include=FALSE}
# Check for collinearity between predictors
vif(mod=RUCRmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(RUCRmod))
qqnorm(residuals(RUCRmod))
qqline(residuals(RUCRmod))
# homogeneity
plot(RUCRmod)
# No obvious deviations from normality, looks like some structure in the residuals vs fitted values
```

```{r RUCR estimate marginal means}
RUCRmod.fit <- RUCR
fit.RUCRmod <- fitted(RUCRmod) 
RUCRmod.fit <- mutate(RUCRmod.fit, fit.RUCRmod)
emmsRUCR <- emmip(RUCRmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

```{r RUCR stig length fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = RUCRmod.fit, aes(x=Stigma_length, y=fit.RUCRmod)) + 
  # geom_smooth(data=RUCRmod.fit, aes(x=Stigma_length, y=fit.RUCRmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsRUCR, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r RUCR fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = RUCR, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsRUCR, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = RUCR, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```


### Schizacne purpurascens (n=30)

```{r SCPU pre-fit}
SCPU <- stigl %>% 
  filter(Species=="Schizacne purpurascens") %>% 
  as.data.frame()
# summary(SCPU) 
SCPU$Inv_avg_dist <- 1/(SCPU$Avg_dist)
```

```{r SCPU take a look, include=F}
#Taking a look at the data
hist(SCPU$Flw_pollen) # response variable. right-skewed
hist(SCPU$Log_flw_pollen) # more symmetric 
hist(SCPU$Infl_max) # looks ok, kind of right skewed
hist(SCPU$Stigma_length) # looks ok  
hist(SCPU$Avg_dist)
hist(SCPU$Inv_avg_dist)
table(SCPU$Date) 
```

```{r SCPU covariates and pollen load, include=F}
ggplot(data=SCPU, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=SCPU, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=SCPU, aes(x=Inv_avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=SCPU, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r SCPU model fit}
# fit full model with all terms
SCPUmod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=SCPU)
summary(SCPUmod)
anova(SCPUmod)
```

No significant effect of anything - gives a warning that some predictors are on very different scales? weird that only this one gives me that error.

```{r test SCPU model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=SCPUmod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(SCPUmod))
qqnorm(residuals(SCPUmod))
qqline(residuals(SCPUmod))
# homogeneity
plot(SCPUmod)
```

Looks like it deviates from normal qqline at upper extreme, no obvious deviations from homoskedasticity in residuals vs fitted value plot

```{r SCPU estimate marginal means}
SCPUmod.fit <- SCPU
fit.SCPUmod <- fitted(SCPUmod) 
SCPUmod.fit <- mutate(SCPUmod.fit, fit.SCPUmod)
emmsSCPU <- emmip(SCPUmod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

```{r SCPU fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = SCPUmod.fit, aes(x=Stigma_length, y=fit.SCPUmod)) + 
  # geom_smooth(data=SCPUmod.fit, aes(x=Stigma_length, y=fit.SCPUmod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsSCPU, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r SCPU fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = SCPU, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsSCPU, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = SCPU, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```

### Scirpus microcarpus (n=30)

```{r SCMI pre-fit}
SCMI <- stigl %>% 
  filter(Species=="Scirpus microcarpus") %>% 
  as.data.frame()
# summary(SCMI) 
SCMI$Inv_avg_dist <- 1/(SCMI$Avg_dist)
```

```{r SCMI take a look, include=F}
#Taking a look at the data
hist(SCMI$Flw_pollen) # response variable. right-skewed
hist(SCMI$Log_flw_pollen) # more symmetric 
hist(SCMI$Infl_max) # looks ok, kind of right skewed
hist(SCMI$Stigma_length) # looks ok  
hist(SCMI$Avg_dist)
hist(SCMI$Inv_avg_dist)
table(SCMI$Date) 
```

```{r SCMI covariates and pollen load, include=F}
ggplot(data=SCMI, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=SCMI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=SCMI, aes(x=Avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=SCMI, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r SCMI model fit}
# fit full model with all terms
SCMImod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Avg_dist + (1|Plant), data=SCMI)
summary(SCMImod)
anova(SCMImod)
```

Significant effect of Date on pollen loads

```{r test SCMI model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=SCMImod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(SCMImod))
qqnorm(residuals(SCMImod))
qqline(residuals(SCMImod))
# homogeneity
plot(SCMImod)
#No obvious deviations from normality, some structure in the residuals vs fitted values plot.

```

```{r SCMI estimate marginal means}
SCMImod.fit <- SCMI
fit.SCMImod <- fitted(SCMImod) 
SCMImod.fit <- mutate(SCMImod.fit, fit.SCMImod)
emmsSCMI_date <- emmip(SCMImod, ~ Date, cov.reduce=range,
              type="response", plotit=F)
```

```{r SCMI date fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = SCMImod.fit, aes(x=Date, y=fit.SCMImod)) + 
  # geom_smooth(data=SCMImod.fit, aes(x=Stigma_length, y=fit.SCMImod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsSCMI_date, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Date", labels=as.character(unique(SCMImod.fit$Date)), 
                     breaks=unique(SCMImod.fit$Date)) +
  theme_cs() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```

```{r SCMI fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = SCMI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsSCMI, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = SCMI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```


### Thalictrum dioicum (n=20)

```{r THDI pre-fit}
THDI <- stigl %>% 
  filter(Species=="Thalictrum dioicum") %>% 
  as.data.frame()
# summary(THDI) 
THDI$Inv_avg_dist <- 1/(THDI$Avg_dist)
```

```{r THDI take a look, include=F}
#Taking a look at the data
hist(THDI$Flw_pollen) # response variable. right-skewed
hist(THDI$Log_flw_pollen) # more symmetric 
hist(THDI$Infl_max) # looks ok, kind of right skewed
hist(THDI$Stigma_length) # looks ok  
hist(THDI$Avg_dist)
hist(THDI$Inv_avg_dist)
table(THDI$Date) 
```

```{r THDI covariates and pollen load, include=F}
ggplot(data=THDI, aes(x=Infl_max, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Plant height") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
    geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=THDI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Stigma length") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=THDI, aes(x=Inv_avg_dist, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Inverse average distance to 5 nearest neighbours") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
ggplot(data=THDI, aes(x=Date, y=Log_flw_pollen)) + 
  geom_point(size=3) + 
  scale_x_continuous(name="Date") + 
  scale_y_continuous(name="Log stigmatic pollen load") + 
  geom_smooth(method="lm", se=F) + 
  theme_cs()
```

```{r THDI model fit}
# fit full model with all terms
THDImod <- lmer(Log_flw_pollen ~ Infl_max + Stigma_length + Date + Inv_avg_dist + (1|Plant), data=THDI)
summary(THDImod)
anova(THDImod)
```

Significant effect of stigma length

```{r test THDI model assumptions, include=F}
# Check for collinearity between predictors
vif(mod=THDImod, type="predictor") # variance inflation factors from package "car"
#normality of residuals
hist(residuals(THDImod))
qqnorm(residuals(THDImod))
qqline(residuals(THDImod))
# homogeneity
plot(THDImod)
```

No obvious deviations from normality or homoskedasticity

```{r THDI estimate marginal means}
THDImod.fit <- THDI
fit.THDImod <- fitted(THDImod) 
THDImod.fit <- mutate(THDImod.fit, fit.THDImod)
emmsTHDI <- emmip(THDImod, ~ Stigma_length, cov.reduce=range,
              type="response", plotit=F)
```

```{r THDI fitted values plot, dpi=200}
# emmip_ggplot(emms) #plots predicted slope
ggplot() + 
  geom_point(data = THDImod.fit, aes(x=Stigma_length, y=fit.THDImod)) + 
  # geom_smooth(data=THDImod.fit, aes(x=Stigma_length, y=fit.THDImod),
  #             method="lm",
  #             formula = y ~ x, linetype=1, colour="black", se=F, linewidth=0.7) + 
  geom_line(data= emmsTHDI, aes(xvar, yvar), linewidth=0.7, colour="blue") +
  scale_y_continuous(name="Stigmatic pollen load",
                     breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
                     labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500)) +
  scale_x_continuous(name = "Stigma length (cm)") +
  theme_cs()
```

```{r THDI fitted slope raw values plot, dpi=200}
# ggplot() + 
#   geom_point(data = THDI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   geom_line(data= emmsTHDI, aes(xvar, yvar), linewidth=0.7) +
#   # geom_smooth(method="lm", colour="blue", data = THDI, aes(x=Stigma_length, y=Log_flw_pollen)) + 
#   scale_y_continuous(name="Stigmatic pollen load",
#                      breaks = log(c(0,1,2,5,10,25,50,100,200,500,1000, 2500)+1),
#                      labels = c(0,1,2,5,10,25,50,100,200,500,1000, 2500),
#                      limits=c(0,NA)) +
#   scale_x_continuous(name = "Stigma length (cm)") + 
# 
#     # scale_x_continuous(name = "Stigma length (cm)",
#     #                  breaks = log(c(0.5, 1, 2, 5)),
#     #                  labels = c(0.5, 1, 2, 5),
#     #                  limits=c(log(0.5),log(5))) +
#   theme_cs()
```


